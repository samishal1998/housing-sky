# Housing Sky
![logo](./public/housing-sky-logo.png)

This App is using the [T3 Stack](https://create.t3.gg/), bootstrapped with `create-t3-app`.

If you are not familiar with the different technologies used in this project, please refer to the respective docs..

- [Next.js](https://nextjs.org)
- [NextAuth.js](https://next-auth.js.org)
- [Prisma](https://prisma.io)
- [Tailwind CSS](https://tailwindcss.com)
- [tRPC](https://trpc.io)

## Running and Building
### ENV Variables
- T3Stack uses the package `@t3-oss/env-nextjs` in combination with `zod` to load and validate the env vars.
- you'll find the code for loading and validation the env in `src/env.js`
- you will also find the template for the `.env` file in `src/.env.example`, a quick explanation of the variables here:
  - `NEXT_PUBLIC_*`: variables starting with this pattern are required in build time and they're passed to the client side
  - `DATABASE_URL`: the uri for the postgress database
  - NextAuth
    - `NEXTAUTH_SECRET`: randomly generated secret for next auth sessions
    - `NEXTAUTH_JWT_SECRET`: : randomly generated secret for next auth JWT
    - `NEXTAUTH_URL`: the base url this app is deployed on.
  - Firebase storage
    - `NEXT_PUBLIC_STORAGE_BUCKET`: the uri for the google storage bucket, `gs://<BUCKET_URI>`. don't add the `gs://` prefix. 
    - `NEXT_PUBLIC_STORAGE_READ_TOKEN`: an authorization token that is passed to the google storage url to read files from the storage. (this could be overridden by allowing public reads in the firebase rules)
    -  The Following 4 variables are required for the instantiation of the firebase App instance in `src/server/firebase-storage.ts`. they are acquired by creating a service account on a google-cloud or a firebase project
      - `FIREBASE_PROJECT_ID`
      - `FIREBASE_CLIENT_ID`
      - `FIREBASE_CLIENT_EMAIL`
      - `FIREBASE_PRIVATE_KEY`
### Database and prisma
- After pulling and before building prisma client should be generated by running
```shell
yarn prisma generate
```
- After the generation of the client the schema should be pushed to the database, (also after any change to the schema, you need to run the same command to migrate the database)
```shell
# Make sure of $DATABASE_URL
yarn db:push
```
### Running Locally
- to run locally, you need to connect to a database
  - you could connect to a dev database that you have hosted somewhere or you could spin up a postgress container by running the following script
```shell
./start-database.sh
```
- and to run the instance, ***make sure all the env variables are defined*** 
```shell
yarn dev
```
### Building
- building the app is very simple, just like any typical Next.js app
```shell
yarn build
```
- and the output is located at `.next`

## Database Schema
![schema](./docs/housing-sky-db-schema.svg)

- Schema file [./prisma/schema.prisma](./prisma/schema.prisma)

- Models:
  - From Next Auth Template
    - Session
    - Account
    - VerificationToken
    - User
  - The `User` Model from the Next Auth Template is also used as the general User Model in the DB
  - The Remaining Models:
    - `Hotel`: the profile of the hotel
    - `HotelManager`: 
      - a joining table to give users access to manage different hotels.
      - This was designed this way to give users access to different hotels nad setting permissions on this joining table itself. but for demo purposes this was not full utilized, but this could be augmented later to enable many to many
    - `Room`: Rooms that are created by the hotel
    - `Booking`: Bookings of rooms that are created by guests of specific Hotel Rooms.
  - Relations:
    - `booked-room`: Many(Booking) To One(Room), the relation to connect the bookings to their rooms.
    - `booking-guest`: Many(Booking) To One(User), the relation to connect the bookings to their creating user.
    - `hotel-rooms`: One(Hotel) To Many(Room), the relation to connect the hotel to its rooms
    - `hotel-managers`: One(Hotel) To Many(HotelManager), the relation connecting a hotel manager to its hotel
    - `hotel-access`: One(User) To One(HotelManager), the relation to connect a user to its access to manage a hotel
    - `room-creator`: Many(Room) To One(HotelManager), the relation to connect hotel mangers to the rooms they added
    - `closed-bookings`: Many(Bookings) To One(HotelManager), the relation to connect hotel mangers to the bookings they close(accepted,rejected,...)
    - The remaining relations are for NextAuth
  - ENUMS:
    - `UserRole`: used for determining what UI to show and for Authorization
    - `RoomType`
    - `BookingStatus`

## User Authorization
- API
  - procedures defined in [TRPC Root](./src/server/trpc.ts)
    - `publicProcedure`: no authorization
    - `protectedProcedure`: required authorization
    - `hotelManagerProcedure`: user must be authorized and a hotel manager
- Page:
  - A layout wraps all the pages [~/components/layouts/layout.tsx](./src/components/layouts/layout.tsx)
  - this layout has a `roleGuard` Prop and it will redirect the user based on the current session and the role guard
- Users can be:
- `Unauthenticated`:
  - these users can only call `publicProcedures`
  - these users can only access pages that don't have a `roleGuard` defined in the layout
- `Authenticated`
  - `HOTEL_MANAGER`
    - these users can only call [`publicProcedures`,`protectedProcedure`,`hotelManagerProcedure`]
    - these users can only access pages that don't have a `roleGuard`, or pages with `HOTEL_MANAGER` roleGuard defined in the layout
  - `GUEST`:
    - these users can only call [`publicProcedures`,`protectedProcedure`]
    - these users can only access pages that don't have a `roleGuard`, or pages with `GUEST` roleGuard defined in the layout
## TRPC folder structure
- A similar structure to NextJS routes was used for the routers in TRPC
- Routers
  - `root`:AppRouter
    - `rooms`: publicProcedures for rooms
    - `user`: user profile related procedures
    - `hotel`: hotel related procedures, almost all are `hotelManagerProcedure`
      - `bookings`: procedures for bookings that can only be done by hotels
      - `rooms`: procedures for rooms that can only be done by hotels
    - `guest`: guest related procedures, almost all are `protectedProcedure`
      - `bookings`: procedures for bookings that can only be done by guest